<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>can i talk to you</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Name Entry Modal -->
    <div class="modal-overlay" id="nameModal">
      <div class="modal">
        <h2>welcome to the chat</h2>
        <p>enter your name to start chatting with your contacts</p>
        <form id="nameForm">
          <input
            type="text"
            class="modal-input"
            id="nameInput"
            placeholder="your name..."
            maxlength="20"
            autocomplete="off"
            required
          />
          <!-- make button a submit button, not "button" -->
          <button type="submit" class="modal-button" id="enterButton">
            enter chat
          </button>
        </form>
      </div>
    </div>

    <!-- Toaster -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Mobile overlay for sidebar -->
    <div
      class="sidebar-overlay"
      id="sidebarOverlay"
      onclick="closeSidebar()"
    ></div>

    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
      ≡
    </button>

    <div class="app-container" id="appContainer">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="app-title">
            <span class="pixelated-logo">can i talk to you</span>
          </div>
        </div>

        <div class="contacts-list">
          <div
            class="contact-item active"
            onclick="selectContact(this, 'claude_ai', 'claude')"
          >
            <div class="contact-avatar">
              c
              <div class="status-dot"></div>
            </div>
            <div class="contact-info">
              <div class="contact-name">claude</div>
              <div class="contact-status">active now</div>
            </div>
          </div>

          <div
            class="contact-item"
            onclick="selectContact(this, 'sarah_j', 'sarah.j')"
          >
            <div class="contact-avatar">s</div>
            <div class="contact-info">
              <div class="contact-name">sarah.j</div>
              <div class="contact-status">5m ago</div>
            </div>
          </div>

          <div
            class="contact-item"
            onclick="selectContact(this, 'mike_dev', 'mike.dev')"
          >
            <div class="contact-avatar">m</div>
            <div class="contact-info">
              <div class="contact-name">mike.dev</div>
              <div class="contact-status">2h ago</div>
            </div>
          </div>

          <div
            class="contact-item"
            onclick="selectContact(this, 'emma_d', 'emma.d')"
          >
            <div class="contact-avatar">
              e
              <div class="status-dot"></div>
            </div>
            <div class="contact-info">
              <div class="contact-name">emma.d</div>
              <div class="contact-status">active now</div>
            </div>
          </div>

          <div
            class="contact-item"
            onclick="selectContact(this, 'alex_r', 'alex.r')"
          >
            <div class="contact-avatar">a</div>
            <div class="contact-info">
              <div class="contact-name">alex.r</div>
              <div class="contact-status">yesterday</div>
            </div>
          </div>

          <div
            class="contact-item"
            onclick="selectContact(this, 'team_lead', 'team.lead')"
          >
            <div class="contact-avatar">t</div>
            <div class="contact-info">
              <div class="contact-name">team.lead</div>
              <div class="contact-status">3d ago</div>
            </div>
          </div>
        </div>

        <div class="status-indicator">[6] contacts • [2] online</div>
      </div>

      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title" id="chatTitle">claude</div>
        </div>

        <div class="messages-area" id="messagesArea">
          <div class="message received">
            hello. i'm claude. how can i assist you today?
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <input
              type="text"
              class="message-input"
              id="messageInput"
              placeholder="type message..."
              onkeypress="handleKeyPress(event)"
            />
            <button class="send-button" onclick="sendMessage()">↗</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      let currentContact = "claude";
      let isSidebarOpen = false;
      let userName = "";

      // Modal functionality
      function enterChat() {
        const nameInput = document.getElementById("nameInput");
        const name = nameInput.value.trim();

        if (name) {
          userName = name;
          console.log("EMITTING userRegister for", name, Date.now());
          socket.emit("userRegister", userName);
        }
      }

      socket.on("userJoined", (user) => {
        const modal = document.getElementById("nameModal");
        const appContainer = document.getElementById("appContainer");

        modal.classList.add("hidden");
        setTimeout(() => {
          appContainer.classList.add("visible");
          document.getElementById("messageInput").focus();
          showToaster(
            "success",
            `welcome ${user.name} with socketId ${user.socketId}`
          );
        }, 300);
      });

      document
        .getElementById("nameForm")
        .addEventListener("submit", function (e) {
          e.preventDefault(); // prevent reload
          enterChat();
        });

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        isSidebarOpen = !isSidebarOpen;

        if (isSidebarOpen) {
          sidebar.classList.add("open");
          overlay.classList.add("active");
        } else {
          sidebar.classList.remove("open");
          overlay.classList.remove("active");
        }
      }

      function closeSidebar() {
        if (isSidebarOpen) {
          toggleSidebar();
        }
      }

      function selectContact(element, contactId, displayName) {
        // Remove active class from all contacts
        document.querySelectorAll(".contact-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Add active class to selected contact
        element.classList.add("active");

        // Update chat title
        document.getElementById("chatTitle").textContent = displayName;
        currentContact = displayName;

        // Clear messages and show initial message
        const messagesArea = document.getElementById("messagesArea");
        messagesArea.innerHTML = "";

        if (displayName === "claude") {
          messagesArea.innerHTML =
            '<div class="message received">hello. i\'m claude. how can i assist you today?</div>';
        } else {
          messagesArea.innerHTML = `<div class="message received">hey, this is ${displayName}. ready to chat?</div>`;
        }

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
          closeSidebar();
        }
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (message) {
          const messagesArea = document.getElementById("messagesArea");

          // Add sent message
          const sentMessage = document.createElement("div");
          sentMessage.className = "message sent";
          sentMessage.textContent = message.toLowerCase();
          messagesArea.appendChild(sentMessage);

          // Simulate response for Claude
          if (currentContact === "claude") {
            setTimeout(() => {
              const response = getClaudeResponse(message);
              const receivedMessage = document.createElement("div");
              receivedMessage.className = "message received";
              receivedMessage.textContent = response;
              messagesArea.appendChild(receivedMessage);
              messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 800 + Math.random() * 1200);
          } else {
            // Simulate response from other contacts
            setTimeout(() => {
              const response = getGenericResponse(currentContact);
              const receivedMessage = document.createElement("div");
              receivedMessage.className = "message received";
              receivedMessage.textContent = response;
              messagesArea.appendChild(receivedMessage);
              messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 600 + Math.random() * 1000);
          }

          input.value = "";
          messagesArea.scrollTop = messagesArea.scrollHeight;
        }
      }

      function getClaudeResponse(message) {
        const responses = [
          "interesting perspective. let me think about that.",
          "i understand what you're asking.",
          "that's a thoughtful question.",
          "i'd be happy to help with that.",
          "good point. here's what i think...",
          "i see what you mean.",
          "that makes sense to me.",
          "thanks for clarifying that.",
          "i appreciate you sharing that.",
          "let me process that for a moment...",
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      }

      function getGenericResponse(contact) {
        const responses = [
          `hey ${userName}, that's cool!`,
          "totally agree with you on that",
          "haha nice one",
          "yeah i see what you mean",
          "that's interesting!",
          "sounds good to me",
          "oh really? tell me more",
          "nice! thanks for sharing",
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // Handle window resize
      window.addEventListener("resize", function () {
        if (window.innerWidth > 768 && isSidebarOpen) {
          closeSidebar();
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Focus on name input when modal loads
        document.getElementById("nameInput").focus();

        // Enable enter button when name is typed
        const nameInput = document.getElementById("nameInput");
        const enterButton = document.getElementById("enterButton");

        nameInput.addEventListener("input", function () {
          if (this.value.trim()) {
            enterButton.disabled = false;
          } else {
            enterButton.disabled = true;
          }
        });
      });

      // Enhanced Retro Toaster Class
      class RetroToaster {
        constructor() {
          this.container =
            document.getElementById("toastContainer") || this.createContainer();
          this.toastCount = 0;
          this.activeToasts = new Map();
        }

        createContainer() {
          const container = document.createElement("div");
          container.id = "toastContainer";
          container.className = "toast-container";
          document.body.appendChild(container);
          return container;
        }

        show(type = "info", title = "", message = "", duration = 5000) {
          const toast = this.createToast(type, title, message, duration);
          this.container.appendChild(toast);

          // Store reference for cleanup
          this.activeToasts.set(toast.id, {
            element: toast,
            timeout: null,
            progressInterval: null,
          });

          // Trigger animation
          requestAnimationFrame(() => {
            toast.classList.add("show");
          });

          // Auto remove with progress bar
          if (duration > 0) {
            this.startProgressBar(toast, duration);
            const timeoutId = setTimeout(() => {
              this.remove(toast);
            }, duration);
            this.activeToasts.get(toast.id).timeout = timeoutId;
          }

          return toast;
        }

        createToast(type, title, message, duration) {
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;
          toast.id = `toast-${++this.toastCount}`;

          const iconMap = {
            success: "✓",
            error: "✗",
            warning: "!",
            info: "i",
          };

          toast.innerHTML = `
            <div class="toast-header">
              <div class="toast-title">
                <span class="toast-icon">${iconMap[type] || iconMap.info}</span>
                ${title}
              </div>
              <button class="toast-close" onclick="toaster.remove(document.getElementById('${
                toast.id
              }'))">&times;</button>
            </div>
            ${message ? `<div class="toast-message">${message}</div>` : ""}
            ${
              duration > 0
                ? `<div class="toast-progress"><div class="toast-progress-bar"></div></div>`
                : ""
            }
          `;

          // Add click to dismiss
          toast.addEventListener("click", (e) => {
            if (!e.target.classList.contains("toast-close")) {
              this.remove(toast);
            }
          });

          return toast;
        }

        startProgressBar(toast, duration) {
          const progressBar = toast.querySelector(".toast-progress-bar");
          if (!progressBar) return;

          let elapsed = 0;
          const interval = 50; // Update every 50ms

          const progressInterval = setInterval(() => {
            elapsed += interval;
            const percentage = (elapsed / duration) * 100;
            progressBar.style.width = `${Math.min(percentage, 100)}%`;

            if (elapsed >= duration) {
              clearInterval(progressInterval);
            }
          }, interval);

          this.activeToasts.get(toast.id).progressInterval = progressInterval;
        }

        remove(toast) {
          if (!toast || !toast.parentNode) return;

          const toastData = this.activeToasts.get(toast.id);
          if (toastData) {
            // Clear timeout and interval
            if (toastData.timeout) clearTimeout(toastData.timeout);
            if (toastData.progressInterval)
              clearInterval(toastData.progressInterval);
            this.activeToasts.delete(toast.id);
          }

          toast.classList.remove("show");
          toast.classList.add("hide");

          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }

        // Convenience methods
        success(title, message = "", duration = 5000) {
          return this.show("success", title, message, duration);
        }

        error(title, message = "", duration = 5000) {
          return this.show("error", title, message, duration);
        }

        warning(title, message = "", duration = 5000) {
          return this.show("warning", title, message, duration);
        }

        info(title, message = "", duration = 5000) {
          return this.show("info", title, message, duration);
        }

        // Clear all toasts
        clear() {
          this.activeToasts.forEach((data, id) => {
            this.remove(data.element);
          });
        }
      }

      // Initialize the toaster
      const toaster = new RetroToaster();

      function showToaster(type, message) {
        toaster[type](type, message);
      }
    </script>
  </body>
</html>